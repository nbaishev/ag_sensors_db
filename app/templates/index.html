<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>График датчиков</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        #chart-container {
            width: 100%;
            height: 100vh;  /* 100% высоты экрана */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #chart {
            width: 100%;
            height: 100%;
        }
        button { padding: 10px; font-size: 16px; margin-top: 10px; }
    </style>
</head>
<body>
    <h2>График температуры и влажности</h2>
    <div id="chart-container">
        <div id="chart"></div>
    </div>
    <button onclick="fetchData()">Обновить график</button>

    <script>
        async function login() {
            const response = await fetch("/auth/plot-login", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                }
            });

            const result = await response.json();
            if (response.ok) {
                jwtToken = result.access_token;
                localStorage.setItem("jwtToken", jwtToken);

                fetchData();  // Загрузить данные сразу после логина
            } else {
                alert("Неверные данные для входа!");
            }
        }

        async function fetchData() {
            let token = localStorage.getItem("jwtToken");
            if (!token) {
                alert("Сначала войдите!");
                return;
            }
            const response = await fetch("/data/get", {
                headers: { "Authorization": "Bearer " + token }
            });

            if (response.status === 401) {
                alert("Токен просрочен или неверен. Пожалуйста, войдите снова.");
                return;
            }

            const result = await response.json();
            if (response.ok) {
                console.log(result);
                updatePlot(result);
            } else {
                console.error("Ошибка:", result.error);
            }
        }

        function updatePlot(data) {
            // Массивы для данных графика
            const timestamps = [];
            const temperatures = [];
            const humidities = [];
            if (!Array.isArray(data)) {
                console.error("Полученные данные не являются массивом:", data);
                return;
            }

            // Преобразуем строки времени в объект Date и собираем данные
            data.forEach(entry => {
                timestamps.push(new Date(entry.timestamp));  // Преобразуем строку в объект Date
                temperatures.push(entry.temperature);  // Преобразуем температуру в число
                humidities.push(entry.humidity);  // Преобразуем влажность в число
            });

            // Строим график с двумя осями
            const trace1 = {
                x: timestamps,
                y: temperatures,
                mode: 'lines',
                name: 'Temperature (°C)',
                line: {color: 'red'}
            };

            const trace2 = {
                x: timestamps,
                y: humidities,
                mode: 'lines',
                name: 'Humidity (%)',
                line: {color: 'blue'}
            };

            const layout = {
                autosize: true,  // График будет автоматически масштабироваться
                title: 'Temperature and Humidity Over Time',
                xaxis: {
                    title: 'Time',
                    type: 'date'
                },
                yaxis: {
                    title: 'Temperature (°C)',
                    side: 'left'
                },
                yaxis2: {
                    title: 'Humidity (%)',
                    side: 'right',
                    overlaying: 'y'
                }
            };

            const dataToPlot = [trace1, trace2];

            // Отображаем график
            Plotly.newPlot('chart', dataToPlot, layout);
            window.onresize = function() {
                Plotly.Plots.resize(document.getElementById('chart'));
            };
        }
        login();
        fetchData();
    </script>
</body>
</html>
